{% import '@SyliusShop/shared/buttons.html.twig' as buttons %}

{% set resources = hookable_metadata.context.resources|default([]) %}
    {% if not resources or resources|length == 0 %}
    <div class="alert alert-info text-center">
        <h4>{{ 'app.ui.no_video_generations_yet'|trans }}</h4>
        <p>{{ 'app.ui.create_your_first_video'|trans }}</p>
        <a href="{{ path('app_shop_video_generation_create') }}" class="btn btn-primary">
            {{ ux_icon('tabler:sparkles', { class: 'icon me-2' }) }}
            {{ 'app.ui.nav.generate'|trans }}
        </a>
    </div>
{% else %}
    <div class="row g-4">
        {% for generation in resources %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100 shadow border-0 overflow-hidden">
                    <!-- Video Thumbnail/Preview -->
                    <div class="position-relative">
                        {% if generation.status == 'completed' and generation.videoUrl %}
                            <div class="ratio ratio-16x9">
                                <video controls class="object-fit-cover">
                                    <source src="{{ generation.videoUrl }}" type="video/mp4">
                                    {{ 'app.ui.video_not_supported'|trans }}
                                </video>
                            </div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-success">
                                    {{ ux_icon('tabler:check', { class: 'icon icon-xs me-1' }) }}
                                    {{ 'app.ui.completed'|trans }}
                                </span>
                            </div>
                        {% elseif generation.status == 'processing' %}
                            <div class="ratio ratio-16x9 bg-dark"></div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-primary">
                                    <div class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.75rem; height: 0.75rem;">
                                        <span class="visually-hidden">{{ 'app.ui.processing'|trans }}</span>
                                    </div>
                                    {{ 'app.ui.processing'|trans }}
                                </span>
                            </div>
                        {% elseif generation.status == 'pending' %}
                            <div class="ratio ratio-16x9 bg-dark"></div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-warning">
                                    <div class="spinner-border spinner-border-sm me-1" role="status" style="width: 0.75rem; height: 0.75rem;">
                                        <span class="visually-hidden">{{ 'app.ui.pending'|trans }}</span>
                                    </div>
                                    {{ 'app.ui.pending'|trans }}
                                </span>
                            </div>
                        {% else %}
                            <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center">
                                {{ ux_icon('tabler:video', { class: 'text-muted', style: 'font-size: 3rem;' }) }}
                            </div>
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-secondary">
                                    {{ ux_icon('tabler:video', { class: 'icon icon-xs me-1' }) }}
                                    {{ generation.status }}
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Card Body with Accordion -->
                    <div class="card-body d-flex flex-column p-3">
                        <div class="flex-grow-1">
                            <!-- Always visible info -->
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <small class="text-muted">
                                    {{ generation.createdAt|date('d/m/Y H:i') }} - {{ generation.tokenCost }} tokens
                                </small>
                                
                                <div class="d-flex align-items-center gap-1">
                                    {% if generation.status == 'completed' and generation.videoUrl %}
                                        <a href="{{ generation.videoUrl }}" download class="btn btn-xs btn-link text-muted p-0">
                                            {{ ux_icon('tabler:download', { class: 'icon icon-xs' }) }}
                                        </a>
                                    {% endif %}
                                    
                                    <!-- Expand/Collapse Button -->
                                    <button class="btn btn-xs btn-link text-muted p-0" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#details-{{ generation.id }}" 
                                            aria-expanded="false">
                                        {{ ux_icon('tabler:dots-vertical', { class: 'icon icon-xs' }) }}
                                    </button>
                                </div>
                            </div>

                            <!-- Collapsible Details Section -->
                            <div class="collapse" id="details-{{ generation.id }}">
                                <div class="border-top pt-2">
                                    <p class="small text-muted mb-2 lh-base">
                                        <small class="badge bg-light text-dark me-2">prompt</small>{{ generation.prompt }}
                                    </p>
                                    <div class="d-flex gap-1 justify-content-end">
                                        <button class="btn btn-xs btn-outline-secondary" onclick="navigator.clipboard.writeText('{{ generation.prompt|e('js') }}')">
                                            {{ ux_icon('tabler:copy', { class: 'icon icon-xs' }) }}
                                        </button>
                                        <a href="{{ path('app_shop_video_generation_delete', {id: generation.id}) }}" 
                                           class="btn btn-xs btn-outline-danger"
                                           onclick="return confirm('{{ 'app.ui.delete_confirm'|trans }}')">
                                            {{ ux_icon('tabler:x', { class: 'icon icon-xs' }) }}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {% endif %}

<style>
.collapse-icon[aria-expanded="true"] .icon {
    transform: rotate(180deg);
}
.transition-transform {
    transition: transform 0.2s ease;
}
</style>